# Reusable deploy workflow for www.tikmatrix.com ecosystem
name: Deploy (Reusable)

on:
  workflow_call:
    inputs:
      artifact-name:
        description: "Name of the build artifact to deploy"
        required: true
        type: string
      target-dir:
        description: "Target directory on server (e.g., /var/www.tikmatrix.com)"
        required: true
        type: string
    secrets:
      SERVER_HOST:
        required: true
      SERVER_USER:
        required: true
      SSH_PRIVATE_KEY:
        required: true
      SERVER_PORT:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-${{ inputs.artifact-name }}

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p ${{ secrets.SERVER_PORT }} -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Upload build artifact to server
        run: |
          scp -i ~/.ssh/deploy_key -P ${{ secrets.SERVER_PORT }} \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            "build-${{ inputs.artifact-name }}.tar.gz" \
            "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/"

      - name: Extract and activate deployment on server
        run: |
          ssh -i ~/.ssh/deploy_key -p ${{ secrets.SERVER_PORT }} \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}" << 'DEPLOY_SCRIPT'
          set -e

          SRC_ARCH="build-${{ inputs.artifact-name }}.tar.gz"
          TARGET_DIR="${{ inputs.target-dir }}"
          BACKUP_DIR="/var/backups/www"

          echo "üöÄ Deploying $SRC_ARCH -> $TARGET_DIR"

          # Create directories
          mkdir -p "$TARGET_DIR"
          mkdir -p "$BACKUP_DIR"

          # Backup current deployment
          BACKUP_NAME="$(basename $TARGET_DIR)-$(date +%Y%m%d_%H%M%S).tar.gz"
          if [[ -d "$TARGET_DIR" && "$(ls -A $TARGET_DIR 2>/dev/null)" ]]; then
              echo "üì¶ Backing up current deployment..."
              tar -czf "$BACKUP_DIR/$BACKUP_NAME" -C "$TARGET_DIR" . 2>/dev/null || true
              # Keep only last 3 backups
              ls -t "$BACKUP_DIR/$(basename $TARGET_DIR)-"* 2>/dev/null | tail -n +4 | xargs -r rm -f
          fi

          # Clear and extract
          echo "ÔøΩÔ∏è Clearing target directory..."
          rm -rf "$TARGET_DIR"/*

          echo "üì¶ Extracting new deployment..."
          tar -xzf "/tmp/$SRC_ARCH" -C "$TARGET_DIR"

          # Set permissions
          echo "üîê Setting permissions..."
          sudo chown -R www-data:www-data "$TARGET_DIR"
          sudo chmod -R 755 "$TARGET_DIR"

          # Cleanup
          echo "üßπ Cleaning up..."
          rm -f "/tmp/$SRC_ARCH"

          echo "‚úÖ Deployment to $TARGET_DIR completed successfully!"
          DEPLOY_SCRIPT

      - name: Cleanup SSH Key
        if: always()
        run: rm -f ~/.ssh/deploy_key
